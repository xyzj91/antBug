/**
 * antBug 蚂蚁bug收集系统
 * author:alen 2018年1月4日
 */

window.antBug=function(e,n){var c={},b=this;b.isInit=!1;c.SERVER_HOST="";c.APP_ID="default";c.DEBUG=!1;b.APIVERSION="1.1";b.messageContent={notifierVersion:b.APIVERSION,userAgent:e.navigator.userAgent,locale:e.navigator.language||e.navigator.userLanguage,url:e.location.href,appId:c.APP_ID,title:n.title,time:(new Date).getTime(),appVersion:"",message:"",fileName:"",lineNumber:"",columnNumber:"",stacktrace:"",type:"",deviceType:"web",osVersion:"",ext:{},breadcrumbs:""};c.collectResourceError=!0;c.collectHttpError=
    !0;c.maxErrorNum=20;c.autoWaittime=2E3;b.push=!1;b.breadcrumbs=[];c.extend=function(){var a,d,b,c,h,f=arguments[0]||{},e=1,m=arguments.length,l=!1;"boolean"===typeof f&&(l=f,f=arguments[e]||{},e++);"object"===typeof f||$.isFunction(f)||(f={});e===m&&(f=this,e--);for(;e<m;e++)if(null!=(a=arguments[e]))for(d in a)b=f[d],c=a[d],f!==c&&(l&&c&&($.isPlainObject(c)||(h=$.isArray(c)))?(h?(h=!1,b=b&&$.isArray(b)?b:[]):b=b&&$.isPlainObject(b)?b:{},f[d]=$.extend(l,b,c)):void 0!==c&&(f[d]=c));return f};b.send=
    function(a){var d=new XMLHttpRequest;d.overrideMimeType&&d.overrideMimeType("text/xml");var b={type:"get",url:"",data:{},success:function(){},error:function(){}};a&&(b=c.extend(b,a));d.open(b.type,b.url);b.data&&d.send(b.data);d.onreadystatechange=function(){4==d.readyState&&(200==d.status?b.success(d.responseText):b.error(d.status))}};b.parseError=function(a){var d=JSON.parse(JSON.stringify(b.messageContent));d.message=a.message;d.fileName=a.fileName;d.lineNumber=a.lineNumber;d.columnNumber=a.columnNumber;
    d.stacktrace=a.stacktrace;d.target=a.target;b.messageContent.breadcrumbs=b.breadcrumbs;b.pushBreadcrumbs(a);return d};b.parseErrorMessage=function(a){var d=b.parseError(a),d=c.extend(d,a);a.type||!1===d.message.indexOf("Uncaught")||(d.type="uncaughtError");return d};b.toJsonStr=function(a){if("undefined"!=typeof JSON)return JSON.stringify(a);if(a instanceof Array){for(var d=[],c=0;r<a.length;c++)d.push(b.toJsonStr(a[c]));return"["+d.join(",")+"]"}var d=[],g;for(g in a)if(a.hasOwnProperty(g)){var c=
    '"'+g+'":',e=a[g];e&&("object"==typeof e?c+=b.toJsonStr(e):"number"==typeof e?c+=e:c=c+'"'+e.replace(/\n/g,"\\n")+'"',d.push(c))}return"{"+d.join(",")+"}"};b.converData=function(a){var b;try{b=toJsonStr(a)}catch(k){delete a.metaData;try{b=toJsonStr(a)}catch(g){return}}return b};b.isString=function(a){return"string"==typeof a&&a.constructor==String};b.dump=function(a,d){c.DEBUG&&(b.isString(a)||(a=JSON.stringify(a)),console.log(a),d&&console.log(d))};c.error=function(a){if(c.maxErrorNum){--c.maxErrorNum;
    var d=b.converData(b.parseErrorMessage(a));b.dump(d);b.lastMessage=a;d&&b.push?(b.lastMessage={},b.send({type:"post",url:c.SERVER_HOST,data:d,success:function(a){b.dump(a);b.removeBreadcrumbs()},error:function(a){b.dump(a,"\u8bb0\u5f55\u4e0a\u4f20\u5931\u8d25")}})):b.push||b.dump("\u9875\u9762\u672a\u51c6\u5907\u597d,\u6682\u4e0d\u4e0a\u4f20\u65e5\u5fd7,\u5c06\u65e5\u5fd7\u8bb0\u5f55\u8d77\u6765")}};c.start=function(a){b.push=!0;c.maxErrorNum+=1;a&&(b.messageContent=c.extend(b.messageContent,a));
    b.dump("\u9875\u9762\u51c6\u5907\u5b8c\u6210,\u4e3b\u52a8\u5f00\u542fbug\u4e0a\u4f20");b.lastMessage?(b.dump("\u9875\u9762\u5b58\u5728\u5f02\u5e38,\u4e0a\u4f20bug"),c.error(b.lastMessage)):b.dump("lastMessage \u65e0\u5185\u5bb9")};b.pushBreadcrumbs=function(a){a.breadcrumbs&&delete a.breadcrumbs;b.breadcrumbs.push(a);b.breadcrumbs.length>c.maxErrorNum&&b.breadcrumbs.shift()};b.removeBreadcrumbs=function(){b.breadcrumbs=[]};b.parseUrl2Xpath=function(a){for(var b=[];a&&a.nodeType==Node.ELEMENT_NODE;a=
    a.parentNode){var c,e=0,h=!1;for(c=a.previousSibling;c;c=c.previousSibling)c.nodeType!=Node.DOCUMENT_TYPE_NODE&&c.nodeName==a.nodeName&&++e;for(c=a.nextSibling;c&&!h;c=c.nextSibling)c.nodeName==a.nodeName&&(h=!0);b.splice(0,0,(a.prefix?a.prefix+":":"")+a.localName+(e||h?"["+(e+1)+"]":""))}return b.length?"/"+b.join("/"):null};b.parseSelector=function(a){for(var b=[];a.parentNode;){if(a.id){b.unshift("#"+a.id);break}if(a==a.ownerDocument.documentElement)b.unshift(a.tagName);else{for(var c=1,e=a;e.previousElementSibling;e=
    e.previousElementSibling,c++);b.unshift(a.tagName+":nth-child("+c+")")}a=a.parentNode}return b.join(" > ")};c.resourceErrorAdaper=function(a){if(c.collectResourceError&&!a.message){var d,k=(d=a.target?a.target:a.srcElement)&&d.outerHTML;k&&200<k.length&&(k=k.slice(0,200));var g={type:"resourceError",fileName:d.fileName,lineNumber:a.lineNumber,columnNumber:a.columnNumber,stacktrace:a.stacktrace,target:{outerHTML:k,src:d&&d.src,tagName:d&&d.tagName,id:d&&d.id,className:d&&d.className,name:d&&d.name,
        type:d&&d.type,XPath:b.parseUrl2Xpath(d),selector:b.parseSelector(d),timeStamp:a.timeStamp}};d.src===e.location.href||d.src&&d.src.match(/.*\/(.*)$/)&&!d.src.match(/.*\/(.*)$/)[1]||!g.target.src||!e.XMLHttpRequest||(a=new XMLHttpRequest,a.AntDebug=!0,a.open("HEAD",g.target.src),a.send(),a.onload=function(a){200!==a.target.status&&(g.target.status=a.target.status,g.target.statusText=a.target.statusText);c.error(g)})}};b.listenerError=function(){e.onerror=function(a,b,e,g,h){c.error({message:a,fileName:b,
    lineNumber:e,columnNumber:g,stacktrace:h})};n.onreadystatechange=function(){}};b.checkHttpStatus=function(a){return c.collectHttpError&&(1==a.detail.status||!/^file:\/\/\//.test(a.detail.url))&&2!==parseInt(a.detail.status/100)};c.resourceError=function(){e.addEventListener&&e.addEventListener("error",c.resourceErrorAdaper,!0);b._hashchange=e.onhashchange;e.onhashchange=function(){return b._hashchange.apply(this,arguments)};if(e.XMLHttpRequest&&(b.prototype=XMLHttpRequest.prototype,b.prototype)){var a,
    d,k,g=b.prototype.open;b.prototype.open=function(b,c){k=(new Date).getTime();a=b;d=c;try{g.apply(this,arguments)}catch(m){console.log("\u8bf7\u6c42\u5931\u8d25")}};var h=b.prototype.send;b.prototype.send=function(){var f=this,g=f.onreadystatechange;f.onreadystatechange=function(){if(4===f.readyState){var h=(new Date).getTime()-k,l={type:"XMLHttpRequest",page:{url:e.location.href},detail:{method:a,url:f.responseURL||d,status:f.status,statusText:f.statusText},elapsedTime:h,time:k};b.checkHttpStatus(l)&&
c.error({type:"httpError",req:{method:l.detail.method,url:l.detail.url},res:{status:f.status,statusText:f.statusText,response:f.response,elapsedTime:h}})}g&&g.apply(this,arguments)};h.apply(this,arguments)}}};c.setExt=function(a){a&&(b.messageContent.ext=a)};c.init=function(a){if(b.isInit)return c;b.isInit=!0;c.resourceError();b.listenerError();a&&(b.messageContent=c.extend(b.messageContent,a));e.onload=function(){b.push||setTimeout(function(){b.push||c.start()},c.autoWaittime)};return c};return c}(window,
    document);


/**demo 集成时请去掉
 antBug.init({
    appVersion: "3.1",//app版本
});
 antBug.start();//启动异常上报
 antBug.collectHttpError = false;
 antBug.collectResourceError = true;
 antBug.SERVER_HOST = "http://www.baidu.com";
 **/
